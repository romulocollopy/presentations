<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js â€“ The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Refactor Offsite</h1>
					<h3>Why to fefactor?</h3>
                    <ul>
                        <li>item 1</li>
                        <li>item 2</li>
                        <li>item 3</li>
                    </ul>
				</section>

				<section>
					<h2>Where we begin</h2>
					<p>
                       radon cc . --mi F
					</p>
                        <pre>
                        <code data-trim>
eshares/common/ajax_views.py
    M 572:4 ModifyIssuableModalMixin.get_context_data - F
    M 803:4 BulkModifyIssuableModalMixin.get_context_data - F
eshares/common/management/commands/scheduled_checkup.py
    ERROR: invalid syntax (&lt; unknown &gt;, line 34)
eshares/corporations/ajax_views.py
    C 1816:0 SavePermissions - F
    M 1821:4 SavePermissions.get_context_data - F
    C 2239:0 GetCapTable - F
    M 2243:4 GetCapTable.get_context_data - F
    C 980:0 CreateCorporation - F
    M 983:4 CreateCorporation.get_context_data - F
eshares/corporations/permissions.py
    F 32:0 get_corporation_pks - F
eshares/onboarding/importer/eshares_bulk.py
(...)
                        </code>
                        </pre>
				</section>

				<section>
					<h2>Pick one method</h2>
					<p>
                        M 1821:4 SavePermissions.get_context_data - F
					</p>
                    <pre><code>
class SavePermissions(AjaxView):
    # ...

    def get_context_data(self, **kwargs):
        def get_permissions(role):
            # ... 12 lines
            return perms
        # ... ~250 lines

        self.existing_cur = existing_cur
        return {'success': True}
        </code></pre>

				</section>

				<section>
					<h2>First Step</h2>
                    <h3>Test all the stuff</h3>
                    <small>you mean... all?</small>
                    <small>yeah...</small>
				</section>

				<section>
					<h1>The first test</h1>
					<p>
                        It's a view, so, when I call it, it should give me a success status code
					</p>
                    <pre><code>
class SavePermissionsAjaxViewTestCase(PostAjaxTestCaseMixin,
                                      LoggedInUserTestCaseMixin,
                                      TestCase):
    def setUp(self):
        self.url = reverse('corporations:permission_save')
        self.user_create_and_login()
        self.valid_post_data = dict(
            corporation_pk=1,
            payload=json.dumps(payload)
        )

    def test_200(self, corp):
        resp = self.post_ajax(**self.valid_post_data)
        self.assertEqual(200, resp.status_code)
                    </code></pre>
				</section>
                <section>
                    <p>PostAjaxTestCaseMixin, LoggedInUserTestCaseMixin...</p>
                    <pre><code>
class PostAjaxTestCaseMixin(object):
    def post_ajax(self, **kwargs):
        return self.client.post(
            self.url,
            kwargs,
            HTTP_X_REQUESTED_WITH='XMLHttpRequest',
        )

class LoggedInUserTestCaseMixin(object):
    def user_create_and_login(self, username="mary", password="123"):
        from eshares.common.models import User
        User.objects.create_user(username=username, password=password)
        self.client.login(username=username, password=password)
                    </code></pre>
				</section>
				<section>
                    <h1>Why it was an difficult first test</h1>
                    <ul>
                        <li>Login</li>
                        <li>Permissions</li>
                        <li>request method</li>
                    </ul>
				</section>
                <section>
                    <h1>What did I learn from this test?</h1>
                    <ul>
                        <li>The view demands one ajax call</li>
                        <li>The payload is supposed to be post form params</li>
                        <li>The response status code does not garantee success</li>
                        <li>The response is a json object (and the request payload isn't)</li>
                        <li>The view deals with a GET or a POST request the same way (should it?)</li>
                    </ul>
                </section>
                <section>
                    <h1>Second test</h1>
                    <p>What does it take to get an success response?</p>
                    <pre><code>
@mock.patch('eshares.corporations.ajax_views.EntityOrgPermission')
@mock.patch('eshares.corporations.ajax_views.Corporation')
def test_sucess(self, corp, role):
    resp = self.post_ajax(**self.valid_post_data)
    resp_content = json.loads(resp.content)
    self.assertTrue(resp_content['success'])
                    </code></pre>
                    <p>Does it garantee the permissions are saved? No...</p>
                </section>
                <section>
                    <h1>What did I learn from this test?</h1>
                    <ul>
                        <li>How to hack the view workflow</li>
                        <li>Success depends on a <code>CorporationUserRoles</code> or an <code>EntityOrgPermission</code> in at least one flow</li>
                    </ul>
                </section>
                <section>
                    <h1>Third Test</h1>
                    <p>Since I have already explored the functions inputs and output, I'll explore the functions's behaviors and side effects</p>
                    <pre><code>
    def get_context_data(self, **kwargs):
        def get_permissions(role):
            perms = CorporationPermissions.get_initial_perms_dict()
            for perm in {x.rsplit('_', 1)[0] for x in perms}:
                # do stuff
            if 'role' in role and ...
                # do stuff
            return perms
        # ... 
        payload = json.loads(kwargs['payload'])
        # ...
        perms = get_permissions(payload)
        # ...
        return stuff
                    </code></pre>
                    <p>How can I test it?</p>
                </section>
                <section>
                    <p>How can I test it?</p>
                    <ul>
                        <li>I can instantiate the class and call the method with the desired kwargs :)</li>
                        <li>I can mock CorporationPermissions.get_initial_perms_dict() :)</li>
                        <li>I can't access <code>perms</code> outsite get_context_data context :(</li>
                        <li>I can't call the function outside get_context_data context :(</li>
                    </ul>
                    <small>?!? ðŸ˜•</small>
                </section>
                <section>
                    <p>I wasn't supposed to change the method at this time, but I can't figure any other way to test it. So, I'll move the inner function to an flagged-as-private method</p>
                    <pre><code>
    def get_context_data(self, **kwargs):
        # ... 
        payload = json.loads(kwargs['payload'])
        # ...
        perms = self._get_permissions(payload)
        # ...
        return stuff

    def _get_permissions(self, role):
        perms = CorporationPermissions.get_initial_perms_dict()
        for perm in {x.rsplit('_', 1)[0] for x in perms}:
            # do stuff
        if 'role' in role and ...
            # do stuff
        return perms
                    </code></pre>
                </section>
                <section>
                    <p>Now I can mock <code>_get_permissions</code> and test <code>get_context_data</code> behavior with previsible permitions</p>
                    <pre><code>
@mock.patch('eshares.corporations.ajax_views.'
            'SavePermissions._get_permissions')
def test_get_permissions_is_called(self, mocked_get_permissions):
    self.post_ajax(**self.valid_post_data)
    mocked_get_permissions.assert_called_once_with(self.payload)
                    </code></pre>
                </section>

                <section>
                    <p>I can even send desired pre-set values of return to <code>_get_permissions</code></p>
                    <pre><code>
@mock.patch('eshares.corporations.ajax_views.'
            'SavePermissions._get_permissions')
def test_get_permissions_is_called(self, mocked_get_permissions):
    # setUp
    mocked_get_permissions.return_value = {'corporation_view': True}

    # code execution
    self.post_ajax(**self.valid_post_data)

    # verification of result
    mocked_get_permissions.assert_called_once_with(self.payload)
                    </code></pre>
                </section>
                <section>
                    <p>And we can test the code expecting behaviors determined by the mock</p>
                    <pre><code>
@mock.patch('eshares.corporations.ajax_views.'
            'SavePermissions._get_permissions')
def test_get_permissions_is_called(self, mocked_get_permissions):
    # setUp
    mocked_get_permissions.return_value = {'corporation_view': True}

    # code execution
    resp = self.post_ajax(**self.valid_post_data)

    # verification of result
    self.assertTrue(resp.context['can_view_corporation'])

    # ^ but it's a fake code...
                    </code></pre>
                </section>
                <section>
                    <h3>Basic test workflow</h3>
                    <ul>
                        <li>Set up the conditions</li>
                        <li>Run de code</li>
                        <li>Verify the results</li>
                        <li>Maybe tear down and clean stuff</li>
                    </ul>
                </section>
                <section>
                    <h3>Not good</h3>
                    <pre><code>
@mock.patch('eshares.corporations.ajax_views.'
            'SavePermissions._get_permissions')
@mock.patch('eshares.corporations.ajax_views.Corporation')
def test_get_permissions_is_called(self, MockCorp, mocked_get_permissions):
    # setUp
    mocked_get_permissions.return_value = {'corporation_view': True}

    # code execution
    resp = self.post_ajax(**self.valid_post_data)

    #setUp
    MockCorp.objects.get.return_value = 3

    # verification of result
    self.assertEqual(3, resp['Corp'].objects.get(id=3))

    #run code
    resp.to_json()

    # verification of result
    self.assertTrue(resp.context['can_view_corporation'])
                    </code></pre>
                </section>
                <section>
                    <h4>#Change owner and try again</h4>
                    <pre><code>
def test_UpdateCustomPrice(self):
    # Create a certificate
    cert = self.create_issuable(state=Certificate.STATUS_ACCEPTED)

    request = self.get_request(self.update_custom_price_url,
                               {'corporation_pk': self.corporation.pk,
                                'certificate_pk': cert.pk,
                                'value': 1.50})
    view = login_required(UpdateCustomPrice.as_view())

    # Test permissions for users not allowed to access the view
    self._test_permissions(request, view, users_no_permission=[
        self.user, self.user_basic, self.user_privileged,
        self.user_officer, self.user_admin
    ])

    # Change owner and try again
    cert.owner = self.entity
    cert.save()
    request.user = self.user
    self.user.clear_phased_cache()
    response = view(request)
    self.assertSuccessTrue(response)
    self.assertEqual(
        Certificate.objects.get(pk=cert.pk).get_current_price(),
        1.50
    )

    # Test error case
    request = self.get_request(self.update_custom_price_url,
                               {'corporation_pk': self.corporation.pk,
                                'certificate_pk': cert.pk,
                                'value': 'foo'})
    request.user = self.user
    response = view(request)
    self.assertSuccessFalse(response)
                    </code></pre>
                </section>
                <section>
                    <h1>A different test, must be in a different test method</h1>
                    <small>I'd like to put something funny here, but I lack creativity =/</small>
                </section>
                <section>
                    <h4></h4>
                    <pre><code></code></pre>
                </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
